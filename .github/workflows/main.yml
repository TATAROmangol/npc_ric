name: Production Deploy
on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      # 1. Отключаем автоочистку, чтобы не трогать postgres_data
      - name: Получить код
        uses: actions/checkout@v4
        with:
          clean: false  # Не удалять файлы автоматически
          persist-credentials: false

      # 2. Вручную удаляем только то, что можно
      - name: Очистка рабочей директории
        run: |
          cd /home/github-runner/actions-runner/_work/npc_ric/npc_ric
          # Удаляем всё, кроме папки deploy
          find . -mindepth 1 -maxdepth 1 ! -name 'deploy' -exec rm -rf {} +
          # Внутри deploy удаляем всё, кроме postgres_data и .env
          cd deploy
          find . -mindepth 1 ! -name 'postgres_data' ! -name '*.env' ! -name 'docker-compose*' -exec rm -rf {} +

      # 3. Запускаем контейнеры
      - name: Развертывание Docker
        working-directory: ./deploy
        run: |
          docker-compose down -v --remove-orphans || true
          docker-compose up -d --build --force-recreate
          docker-compose ps